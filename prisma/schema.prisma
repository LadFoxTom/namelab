generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  password     String
  createdAt    DateTime      @default(now())
  searches     Search[]
  subscription Subscription?
  savedDomains SavedDomain[]
}

model SavedDomain {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  domain           String
  reasoning        String
  namingStrategy   String
  brandabilityScore Int
  memorabilityScore Int
  seoScore         Int
  lqsScore         Int?
  providers        Json
  cheapestProvider Json?
  savedAt          DateTime @default(now())

  @@unique([userId, domain])
  @@index([userId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  user                 User      @relation(fields: [userId], references: [id])
  stripeCustomerId     String?
  stripeSubscriptionId String?   @unique
  status               String // "active", "canceled", "past_due"
  currentPeriodEnd     DateTime?
  createdAt            DateTime  @default(now())
}

model Search {
  id           String             @id @default(cuid())
  userId       String?
  user         User?              @relation(fields: [userId], references: [id])
  businessIdea String
  industry     String?
  createdAt    DateTime           @default(now())
  suggestions  DomainSuggestion[]
}

model DomainSuggestion {
  id                String        @id @default(cuid())
  searchId          String
  search            Search        @relation(fields: [searchId], references: [id])
  domain            String
  available         Boolean
  reasoning         String
  namingStrategy    String
  brandabilityScore Int
  memorabilityScore Int
  seoScore          Int
  lqsScore          Int?
  providers         DomainPrice[]
  createdAt         DateTime      @default(now())
}

model DomainPrice {
  id           String           @id @default(cuid())
  suggestionId String
  suggestion   DomainSuggestion @relation(fields: [suggestionId], references: [id])
  registrar    String // "namecheap", "godaddy", "namesilo"
  price        Decimal
  currency     String           @default("USD")
  affiliateUrl String
  available    Boolean
  isPremium    Boolean          @default(false)
  createdAt    DateTime         @default(now())

  @@unique([suggestionId, registrar])
}

model AffiliateClick {
  id           String    @id @default(cuid())
  userId       String?
  domain       String
  registrar    String
  affiliateUrl String
  clickedAt    DateTime  @default(now())
  convertedAt  DateTime?
}

model TrademarkCache {
  id         String   @id @default(cuid())
  domainName String   @unique
  risk       String
  resultJson Json
  checkedAt  DateTime @default(now())
  expiresAt  DateTime

  @@index([domainName])
}

// Brand Identity Feature
model BrandSession {
  id          String        @id @default(cuid())
  domainName  String
  tld         String
  searchQuery String
  userId        String?
  anonymousId   String?
  signals       Json
  progress      String?
  status        BrandStatus   @default(PENDING)
  showInGallery Boolean       @default(true)
  concepts      BrandConcept[]
  purchases     BrandPurchase[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([domainName])
  @@index([anonymousId])
  @@index([userId])
  @@index([showInGallery, status])
}

model BrandConcept {
  id              String       @id @default(cuid())
  brandSessionId  String
  brandSession    BrandSession @relation(fields: [brandSessionId], references: [id], onDelete: Cascade)
  style           String
  previewUrl      String
  originalUrl     String
  isSelected      Boolean      @default(false)
  generationIndex Int
  promptUsed      String       @db.Text
  score           Int          @default(0)
  evaluationFlags String[]     @default([])
  attemptCount    Int          @default(1)
  passedEvaluation Boolean     @default(false)
  createdAt       DateTime     @default(now())

  @@index([brandSessionId])
}

model BrandPurchase {
  id                    String         @id @default(cuid())
  brandSessionId        String
  brandSession          BrandSession   @relation(fields: [brandSessionId], references: [id])
  tier                  PurchaseTier
  stripePaymentIntentId String         @unique
  stripeSessionId       String?
  status                PurchaseStatus @default(PENDING)
  downloadUrl           String?
  downloadExpiresAt     DateTime?
  zipR2Key              String?
  email                 String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  @@index([stripePaymentIntentId])
}

enum BrandStatus {
  PENDING
  GENERATING
  READY
  FAILED
}

enum PurchaseTier {
  LOGO_ONLY
  BRAND_KIT
  BRAND_KIT_PRO
}

enum PurchaseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}
